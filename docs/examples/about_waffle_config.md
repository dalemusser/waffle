# WAFFLE Configuration Overview  
*A complete guide to how configuration works in WAFFLE applications.*

WAFFLE‚Äôs configuration system is designed to be:

- **explicit**  
- **predictable**  
- **simple to override**  
- **easy to teach**  
- **easy for AI to generate**  

This document explains the **whole picture** of how WAFFLE handles configuration values, including:

1. Configuration sources  
2. How values flow into `CoreConfig` and `AppConfig`  
3. The environment variable prefix  
4. Configuration precedence  
5. Example config files  
6. How to reference config values in your handlers  
7. Links to additional pattern/example documents  

Everything here applies to all WAFFLE applications.

---

# üß± 1. WAFFLE Configuration Sources

By default, configuration may come from three places:

### ‚úî 1. **Configuration files**  
WAFFLE supports (via Viper):

- `config.toml`  
- `config.yaml`  
- `config.json`

Files are loaded automatically if present in the working directory or in standard config paths.

### ‚úî 2. **Environment variables**  
Environment variables always use the **`WAFFLE_` prefix**.

Examples:

```
WAFFLE_ENV=production
WAFFLE_GREETING="Hello WAFFLE"
WAFFLE_PORT=8080
```

### ‚úî 3. **Command-line flags**  
If the developer chooses to add flag overrides, WAFFLE will always place CLI flags at the highest precedence.

*(WAFFLE itself does not require flags by default, but apps may add them.)*

---

# üß© 2. How Config Maps Into `CoreConfig` and `AppConfig`

WAFFLE distinguishes between two kinds of configuration:

## **A. CoreConfig**  
Provided by WAFFLE itself.  
Controls framework-level behavior such as:

- environment (`env`)
- logging level (`log_level`)
- server port
- index boot timeout
- future WAFFLE defaults

This struct is defined inside WAFFLE.

## **B. AppConfig**  
Defined **per application** and generated by `makewaffle`.

**File:**  
`internal/app/bootstrap/appconfig.go`  
**Created by:** makewaffle

Example:

```go
package bootstrap

type AppConfig struct {
    Greeting string
}
```

Values for these fields come from:

- config file keys  
- environment variables  
- CLI flags (if added)

Example mappings:

```
config.toml ‚Üí greeting = "Hello"
env var     ‚Üí WAFFLE_GREETING=Hello
```

---

# üè∑ 3. Environment Variable Prefix (`WAFFLE_`)

WAFFLE uses the prefix:

```
WAFFLE_
```

to prevent naming collisions with other software.

Examples:

- `WAFFLE_PORT=8080`  
- `WAFFLE_GREETING="Hi"`  
- `WAFFLE_ENV=production`  

Later, WAFFLE may expose a configurable prefix for app-level fields.  
For now, the prefix is consistent and predictable ‚Äî an advantage for clarity and teaching.

---

# TLS Configuration

WAFFLE supports TLS configuration including:

- `cert_file`: path to the TLS certificate file  
- `key_file`: path to the TLS private key file  
- `domain`: domain name for the TLS certificate  
- `use_lets_encrypt`: boolean to enable automatic certificate management via Let's Encrypt ACME

The `domain` field specifies the domain name for which to obtain or use the TLS certificate.

> **Note on Let‚Äôs Encrypt http‚Äë01 challenges**  
> When using Let‚Äôs Encrypt with the **http‚Äë01** challenge, WAFFLE must listen on **HTTP port 80** so the ACME server can reach `http://<domain>/.well-known/acme-challenge/...`.  
> If you want your WAFFLE app to listen on another port (such as `8080`), you must terminate TLS at a **reverse proxy** (e.g., nginx, Caddy, Cloudflare) and set `use_lets_encrypt = false` so WAFFLE does not attempt to handle ACME itself.

---

# ü•á 4. Configuration Precedence

WAFFLE resolves configuration values in this order (lowest ‚Üí highest):

1. **Default values** in `CoreConfig` or `AppConfig`
2. **Config file** (`config.toml`, `.yaml`, `.json`)
3. **Environment variables** (e.g., `WAFFLE_GREETING`)
4. **Command-line flags** (if used by the app)

This mirrors industry-standard precedence rules.

---

# üìù 5. Example Configuration Files

Below are examples showing how WAFFLE maps config file fields to Go struct fields.

## **TOML**

```toml
greeting = "Hello from TOML"
env = "development"
port = 8080
```

Equivalent environment variables:

```
WAFFLE_GREETING="Hello from TOML"
WAFFLE_ENV=development
WAFFLE_PORT=8080
```

## **YAML**

```yaml
greeting: "Hello from YAML"
env: development
port: 8080
```

## **JSON**

```json
{
  "greeting": "Hello from JSON",
  "env": "development",
  "port": 8080
}
```

---

# üß© 6. Accessing Configuration Inside Your App

Configuration is loaded in:

**File:**  
`internal/app/bootstrap/hooks.go`

The WAFFLE lifecycle loads core config and app config:

```go
coreCfg, appCfg, err := LoadConfig(logger)
```

These are passed into your handlers in:

```go
handler := feature.NewHandler(coreCfg, appCfg, deps, logger)
```

Inside a handler method:

```go
func (h *Handler) ServeHome(w http.ResponseWriter, r *http.Request) {
    message := h.AppCfg.Greeting
    w.Write([]byte(message))
}
```

Handlers always receive configuration explicitly ‚Äî never magically.

---

# üß≠ 7. How Configuration Fits Into the WAFFLE Lifecycle

WAFFLE‚Äôs config loading occurs at the top of the lifecycle:

```
LoadConfig
    ‚Üì
ConnectDB (uses config)
    ‚Üì
EnsureSchema
    ‚Üì
BuildHandler (receives config)
    ‚Üì
Routes(h)
    ‚Üì
HTTP Server
```

This ensures:

- consistent startup  
- easy testing  
- predictable flow  
- simple reasoning  
- clear AI code generation  

---

# üîó 8. Related Example Documents

- **[Examples of AppConfig Patterns](./examples-of-appconfig-patterns.md)**  
  How to structure your AppConfig for real-world apps.

- **[DBDeps Usage Examples](./dbdeps-usage-examples.md)**  
  How configuration passes into DB dependencies.

- **[Handler Structure Examples](./handler-structure-examples.md)**  
  How config flows into handlers.

- **[WAFFLE Provided Configuration Variables](./waffle-provided-config-vars.md)**  
  Full list of built-in CoreConfig keys, types, defaults, and constraints.

---

# ‚≠ê Summary

WAFFLE‚Äôs configuration system is designed to be:

- predictable  
- explicit  
- easy for beginners  
- powerful for experts  
- AI-friendly  

This document provides the complete view of:

- configuration sources  
- env prefix behavior  
- mapping into Go structs  
- precedence  
- examples  
- how config flows through the lifecycle  

Use this doc as the authoritative reference for all future WAFFLE config usage.
